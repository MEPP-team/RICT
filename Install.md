# Install and utilization notes for Unix users

This document first explains how to install and configure all the components
described in the architecture diagram above.

It then explains how to use and run all the components for a 3D and a 3D+time
usecases.

## Install notes

### Install 3DCityDB

If you need to install a 3DCityDB database, follow the instructions described
[here](Install/Install3DCityDB.md).

### Install UDV-server

[UDV-server](https://github.com/MEPP-team/UDV-server) is a collection of tools
useful for our application. For more information, refer to the README.md and the
Install.md files of UDV-server.

### Install py3dtiles

[py3dtiles](https://github.com/MEPP-team/py3dtiles)
([forked from Oslandia](https://github.com/Oslandia/py3dtiles)) is a component
allowing to compute a 3dtiles tileset from a directory or a database. More info
[here](https://github.com/MEPP-team/py3dtiles/blob/3dtiles-temporal-v2/README.rst)

Install pre-requisite tools:
````
    sudo apt-get install python3
    sudo apt-get install python3-pip
    sudo pip3 install virtualenv      # Mind the sudo or the install will happen in `$(HOME)/.local/...`
````

Open a terminal and run:

````
    git clone https://github.com/MEPP-team/py3dtiles.git
    cd py3dtiles
    git checkout 3dtiles-temporal-v2
````

Deploy a virtual environment (this step is not mandatory; it is useful for having local dependencies to the packages installed next.)
````
    virtualenv -p /usr/bin/python3 venv
    . venv/bin/activate
````

Install python dependencies:

````
    pip install -e .
    python setup.py install
````

[Setuptools](https://pypi.python.org/pypi/setuptools) allows to
"Easily download, build, install, upgrade, and uninstall Python packages".

`pip install -e .` gets the requirements from setup.py and install them automatically.

*Dev note: If you modify the core of py3dtiles (py3dtiles/py3dtiles/), you need
to run `pip install -e` before running a script (e.g. export_tileset) for changes
to be considered.*

### Install a server for streaming 3dtiles tilesets to the client

If you want to run a local server for streaming a 3d-tiles tileset, you can use
the node server provided by 3d-tiles:
[3d-tiles-samples](https://github.com/AnalyticalGraphicsInc/3d-tiles-samples)

Install:

````
    git clone https://github.com/AnalyticalGraphicsInc/3d-tiles-samples
    cd 3d-tiles-samples
    npm install
    npm start
````

The examples tilesets are hosted at `http://localhost:8003/tilesets/`

If you want to run a remote server for streaming a 3d-tiles tileset, you can use
an Apache server see Step (6) of Install/InstallVilo3D for more informations on 
how to setup one).

### Install UDV web client and iTowns framework

 Follow the install notes described here:
 https://github.com/MEPP-team/UDV/blob/master/install.md

This will install UDV and pull the right version of itowns (with temporal extension).

After this installation, if you need to work on itowns you can do it in
`UDV/UDV-Core/dist/itowns`. If you do so, beware of the remote which is currently
a fork  (https://github.com/jailln/itowns) of the master (https://github.com/iTowns/itowns).

## Use

Now that you are done with all necessary installation, you can use these components
with 3D or 3D+time data.

### Usecase with 3D data

* If you followed the install step of 3DCityDB you already have 3D data uploaded
into your database. If not, please refer to the end of
[these install notes](Install/Install3DCityDB.md).

* Run `ExtractCityData` tool of UDV-server:

`cd UDV-server` and then follow [these instructions](https://github.com/MEPP-team/UDV-server#use).

*Note: run it without the -t option for this usecase*

This will create a materialized view of the data of your 3DCityDB database.

* Run `export_tileset` tool of `py3dtiles`:

`cd py3dtiles`
edit the `tools/export_tileset_conf.yml` to match your database configuration.

Activate venv and run `export_tileset` tool
````
    . venv/bin/activate
    python tools/export_tileset -D tools/export_tileset_conf.yml
````

* run `3d-tiles-samples` server:

Copy the tileset generated by py3dtiles into 3d-tiles-samples and run the server:
````
    cd path/to/3d-tiles-samples/tilesets
    mkdir 3DTileset
    cd path/to/py3dtiles/
    cp -a tiles/ tileset.json path/to/3d-tiles-samples/tilesets/3DTileset
    cd path/to/3d-tiles-samples/tilesets
    npm start
````

*Note: if you want your node server to be publicly accessible you need to run
`./node_modules/.bin/nodemon --watch bin --watch lib --watch index.js server.js --public true` instead of `npm start`*

Check that your tileset is accessible by opening
http://localhost:8003/tilesets/3DTileset/tileset.json in your web browser.

* run UDV:

````
    cd UDV
````

(Optionnal) If you want to use UDV with your local tileset, then edit UDV building-server query:

open `UDV/UDV-Core/examples/Demo.js` with your favorite editor and change the
line `buildingServerRequest` to http://localhost:8003/tilesets/3DTileset/tileset.json

(end optionnal)

````
    cd UDV-Core
    npm start
````

Open your web browser and go to `http://localhost:8080/examples/Demo.html`

### Usecase with 3D+time data

* Update 3D+time data to your 3DCityDB database. More information in
[these install notes](Install/Install3DCityDB.md).

* Run `ExtractCityData` tool of UDV-server with -t option:

`cd UDV-server` and then follow [these instructions](https://github.com/MEPP-team/UDV-server#use).

This will create a materialized view of the data of your 3DCityDB database.

* Run `export_tileset` tool of `py3dtiles` with temporal option:

`cd py3dtiles`
edit the `tools/export_tileset_conf.yml` to match your database configuration.

Activate venv and run `export_tileset` tool
````
    . venv/bin/activate
    python tools/export_tileset -D tools/export_tileset_conf.yml -t
````

* run `3d-tiles-samples` server:

Copy the tileset generated by py3dtiles into 3d-tiles-samples and run the server:
````
    cd <path/to/3d-tiles-samples>/tilesets
    mkdir 4DTileset
    cd <path/to/py3dtiles/>
    cp -a tiles tileset.json <path/to/3d-tiles-samples>/tilesets/4DTileset
    cd <path/to/3d-tiles-samples>
    npm start
````

*Note: if you want your node server to be publicly accessible you need to run
`./node_modules/.bin/nodemon --watch bin --watch lib --watch index.js server.js --public true` instead of `npm start`*

Check that your tileset is accessible by opening
http://localhost:8003/tilesets/4DTileset/tileset.json in your web browser.

* run UDV:

````
    cd UDV
````

(Optionnal) If you want to use UDV with your local tileset, then edit UDV building-server query:

open `UDV/UDV-Core/examples/Demo.js` with your favorite editor and change the
line `buildingServerRequest` to http://localhost:8003/tilesets/4DTileset/tileset.json

(end optionnal)

````
    cd UDV-Core
    npm start
````

Open your web browser and go to `http://localhost:8080/examples/Demo.html`
